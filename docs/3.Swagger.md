# Swagger

Swaggerë€, Open Api Specification(OAS)ë¥¼ ìœ„í•œ í”„ë ˆì„ì›Œí¬ë¡œì¨ ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ REST APIë¥¼ ë¬¸ì„œí™”í•˜ë©°, ë¬¸ì„œ UIì—ì„œ ë°”ë¡œ API í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•´ì¤€ë‹¤.

## ì˜ì¡´ì„± ì¶”ê°€

```groovy
dependencies {
    //swagger
    implementation("io.springfox:springfox-boot-starter:3.0.0")
}
```

Spring Boot 2.6 ì´ìƒë¶€í„°ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
```
org.springframework.context.ApplicationContextException: Failed to start bean 'documentationPluginsBootstrapper'; nested exception is java.lang.NullPointerException: Cannot invoke "org.springframework.web.servlet.mvc.condition.PatternsRequestCondition.getPatterns()" because "this.condition" is null
```
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” `application.yml` ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì.
```yaml
spring:
  mvc:
    path match:
      matching-strategy: ant_path_matcher
```

<br/>

## Swagger ui

`~/swagger-ui/` ë¡œ ì ‘ì†í•˜ë©´ í™”ë©´ì´ ë‚˜ì˜¨ë‹¤. (ex. http://localhost:8080/swagger-ui/)

![img.png](img.png)


<br/>

## Swagger ì£¼ìš” annotation

- `@ApiOperation` : íŠ¹ì • pathì— ëŒ€í•œ ì„¤ëª….
- `@ApiResponses`, `@ApiResponse` : operationì˜ ì‘ë‹µì— ëŒ€í•œ ì„¤ëª…. ì‘ë‹µ ì½”ë“œ, ë©”ì‹œì§€, ì‘ë‹µ í´ë˜ìŠ¤, ì˜ˆì‹œ ì œê³µ.
- `@ApiModel` : ëª¨ë¸ì— ëŒ€í•œ ì •ë³´. ì´ë¦„, ì„¤ëª…, ë¶€ëª¨ í´ë˜ìŠ¤ ì œê³µ.
- `@ApiModelProperty` : ëª¨ë¸ í”„ë¡œí¼í‹°ì— ëŒ€í•œ ì„¤ëª…. ì„¤ëª…, ë°ì´í„° íƒ€ì…, í•„ìˆ˜ ì—¬ë¶€, ì˜ˆì‹œ ì œê³µ. 

<br/>

## Swagger ì„¤ì • (+ Authorization í—¤ë”)

1. securitySchemes ì •ì˜
2. securityContexts ì •ì˜

```kotlin
@Bean
fun api(): Docket {
    return Docket(DocumentationType.OAS_30)
        .useDefaultResponseMessages(false)
        .securityContexts(listOf(securityContext())) // 2. securityContexts ì •ì˜
        .securitySchemes(listOf(httpScheme()))  // 1. securitySchemes ì •ì˜
        .select()
        .apis(RequestHandlerSelectors.any())
        .paths(PathSelectors.any())
        .build()
}
```

### 1. securitySchemes ì •ì˜

#### security scheme ì¢…ë¥˜

- http : Basic, Bearer, ë‹¤ë¥¸ HTTP ì¸ì¦ schemes (Authorization í—¤ë” ì‚¬ìš©) 
- apiKey : API keyì™€ ì¿ í‚¤ 
- oauth2 : OAuth 2
- openIdConnect : OpenID Connect Discovery

#### BearerAuth ë°©ì‹

> êµ¬ê¸€ë§í•´ë³´ë©´ ëŒ€ë¶€ë¶„ ApiKeyë¥¼ í†µí•´ Headerì— Authorizationì„ keyë¡œ í•˜ëŠ” í˜•íƒœë¡œ í† í° ì¸ì¦ë°©ì‹ì„ êµ¬í˜„í•˜ê³  ìˆìŒ.  
> ê·¸ëŸ¬ë‚˜ Bearer ì¸ì¦ ë°©ì‹ì„ ì‚¬ìš©í•  ê²ƒ ì´ë¼ë©´ êµ³ì´ ApiKey ë°©ì‹ì„ ì‚¬ìš©í•  í•„ìš”ëŠ” ì—†ë‹¤. ì‹¤ì œë¡œ Swagger UIì—ì„œ í…ŒìŠ¤íŠ¸í•  ë•Œ ë§¤ë²ˆ í† í° prefixë¡œ "Bearer " ë¥¼ ì…ë ¥í•˜ëŠ” ê²ƒì€ ë²ˆê±°ë¡œìš´ ì¼ì´ë‹¤. 
> http schemeìœ¼ë¡œ Bearerë¥¼ ì„ íƒí•˜ë©´ "Bearer " prefixë¥¼ ìƒëµí•  ìˆ˜ ìˆë‹¤.

```kotlin
import org.springframework.http.HttpHeaders.AUTHORIZATION
import springfox.documentation.service.HttpAuthenticationScheme.JWT_BEARER_BUILDER

private fun httpScheme(): HttpAuthenticationScheme = HttpAuthenticationScheme(
    /* name = */ AUTHORIZATION, // Authorization
    /* description = */ "jwt í† í°",
    /* type = */ "http",
    /* scheme = */ JWT_BEARER_BUILDER.build().scheme,   // bearer
    /* bearerFormat = */ JWT_BEARER_BUILDER.build().bearerFormat, // JWT
    /* extensions = */ ArrayList()
)
```
- nameì€ headerì˜ key ê°’ì´ë‹¤.
- BasicAuthë¥¼ ì‚¬ìš©í•  ê²½ìš°ëŠ” BASIC_AUTH_BUILDER ë¥¼ ì‚¬ìš©í•˜ì.

#### ApiKey ë°©ì‹

```kotlin
import org.springframework.http.HttpHeaders.AUTHORIZATION

private fun apiKey(): ApiKey = ApiKey(AUTHORIZATION, AUTHORIZATION, "header")
```
- ì²« ë²ˆì§¸ ì¸ìê°€ headerì˜ key ê°’ì´ë‹¤.

### 2. securityContexts ì •ì˜

```kotlin
private fun securityContext(): SecurityContext {
    return SecurityContext.builder()
        .securityReferences(defaultAuth())
        .build();
}

private fun defaultAuth(): List<SecurityReference?> {
    val authorizationScope = AuthorizationScope("global", "accessEverything")
    val authorizationScopes: Array<AuthorizationScope?> = arrayOfNulls(1)
    authorizationScopes[0] = authorizationScope
    return listOf(SecurityReference(AUTHORIZATION, authorizationScopes))
}
```

- ì „ì—­ AuthorizationScopeë¥¼ ì‚¬ìš©í•˜ì—¬ JWT SecurityContext ë¥¼ êµ¬ì„±í•œë‹¤.
- ì´ë•Œ, SecurityReferenceì˜ ì²« ë²ˆì§¸ ì¸ìëŠ” ìœ„ì—ì„œ ì„¤ì • í—¤ë” keyê°’ê³¼ ë™ì¼í•´ì•¼ í•œë‹¤.


### ì „ì²´ ì½”ë“œ

```kotlin
@Bean
fun api(): Docket {
    return Docket(DocumentationType.OAS_30)
        .useDefaultResponseMessages(false)
        .securityContexts(listOf(securityContext()))
        .securitySchemes(listOf(httpScheme()))
        .select()
        .apis(RequestHandlerSelectors.any())
        .paths(PathSelectors.any())
        .build()
}

private fun securityContext(): SecurityContext {
    return SecurityContext.builder()
        .securityReferences(defaultAuth())
        .build();
}

private fun defaultAuth(): List<SecurityReference?> {
    val authorizationScope = AuthorizationScope("global", "accessEverything")
    val authorizationScopes: Array<AuthorizationScope?> = arrayOfNulls(1)
    authorizationScopes[0] = authorizationScope
    return listOf(SecurityReference(AUTHORIZATION, authorizationScopes))
}

// BearerAuth ì‚¬ìš©í•˜ëŠ” ë°©ë²•
private fun httpScheme(): HttpAuthenticationScheme = HttpAuthenticationScheme(
    /* name = */ AUTHORIZATION,
    /* description = */ "jwt í† í°",
    /* type = */ "http",
    /* scheme = */ JWT_BEARER_BUILDER.build().scheme,
    /* bearerFormat = */ JWT_BEARER_BUILDER.build().bearerFormat,
    /* extensions = */ ArrayList()
)
```

> [ì¸ì¦ í—¤ë” ì°¸ê³ ](https://swagger.io/docs/specification/authentication/)






<br/>

> ğŸ”– [ê³µì‹ ë¬¸ì„œ](https://springfox.github.io/springfox/docs/current/)
